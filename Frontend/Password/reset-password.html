<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Reset Password â€” LetsPray</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <style>
    /* small focused styles for the reset page */
    body { font-family: Poppins, sans-serif; display:flex; align-items:center; justify-content:center; min-height:100vh; background:linear-gradient(180deg,#0b0b0b,#111); color:#fff; }
    .card { width: 100%; max-width:420px; background: #0f0f0f; border-radius:12px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,0.6); }
    h1 { color: #e7a92f; margin-bottom:6px; font-size:22px; }
    p.sub { color:#aaa; margin-bottom:18px; }
    .field { margin-bottom:12px; }
    .field input { width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:#0b0b0b; color:#fff; }
    .btn { width:100%; padding:12px; border-radius:8px; border:none; background:linear-gradient(90deg,#e7a92f,#e24c0b); color:#111; font-weight:700; cursor:pointer; }
    .muted { color:#888; font-size:13px; text-align:center; margin-top:12px; }
    .small-btn { background:transparent;color:#e7a92f;border:1px solid rgba(231,169,47,0.15); padding:10px; border-radius:8px; width:100%}
  </style>
</head>
<body>
  <div class="card">
    <h1>Reset your password</h1>
    <p class="sub">Enter your email to receive a 6-digit code. Then enter the code and your new password.</p>

    <div id="step1">
      <div class="field">
        <label>Email</label>
        <input id="email" type="email" placeholder="you@example.com" />
      </div>
      <button id="sendCode" class="btn">Send code</button>
    </div>

    <div id="step2" style="display:none;">
      <div class="field">
        <label>6-digit code</label>
        <input id="code" type="text" maxlength="6" placeholder="123456" />
      </div>
      <div class="field">
        <label>New password</label>
        <input id="newpass" type="password" />
      </div>
      <button id="resetBtn" class="btn">Reset password</button>
    </div>

    <div class="muted">Remembered your password? <a href="/" style="color:#e7a92f">Sign in</a></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:4000';
    document.getElementById('sendCode').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) return alert('Enter your email');
      const res = await fetch(API_BASE + '/auth/forgot-password', {
        method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email })
      });
      const data = await res.json();
      alert(data.message || 'If your email exists, a code was sent');
      if (res.ok) {
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
      }
    });

    document.getElementById('resetBtn').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const code = document.getElementById('code').value.trim();
      const newPassword = document.getElementById('newpass').value;
      if (!email || !code || !newPassword) return alert('Fill all fields');
      const res = await fetch(API_BASE + '/auth/verify-code', {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, code, newPassword })
      });
      const data = await res.json();
      alert(data.message || 'Done');
      if (res.ok) window.location.href = '/';
    });

    // If user lands with token in query (from Google redirect), capture it
    (function captureTokenFromQuery(){
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const name = params.get('name');
      if (token) {
        localStorage.setItem('auth_token', token);
        if (name) localStorage.setItem('auth_user', decodeURIComponent(name));
        // remove query params for cleanliness
        history.replaceState({}, document.title, '/');
        alert('Signed in successfully');
        window.location.href = '/';
      }
    })();
  </script>
</body>
</html>
